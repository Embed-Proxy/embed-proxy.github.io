<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Embed Proxy</title>
<style>
*{transition: all .6s;}
body {
  margin: 0;
  padding: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  background-color: black;
  color: white;
  font-family: Arial, sans-serif;
  overflow: auto; /* allow scrolling when settings are visible */
}
body.loaded {overflow: hidden;} /* hide scroll once loaded */

#container {position: relative; width: 100%; height: 100%;}
iframe {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  border: none;
  pointer-events: none;
}
iframe.top {pointer-events: auto; z-index: 10;}

#enter-url{
  position: absolute;
  inset: 0;
  margin: auto;
  width: fit-content;
  max-width: 90vw;
  min-width: 50vw;
  height: fit-content;
  padding: 2rem;
  background: #111;
  border-radius: .5rem;
  text-align: center;
  box-sizing: border-box;
  z-index: 20;
}
#enter-url input[type="text"]{
  flex: 1;
  min-width: 0;
  padding: .7rem;
  margin: .5rem 0;
  font-size: 1.1rem;
  background: #222;
  border: 1px solid #555;
  border-radius: .7rem;
  color: #fff;
}
#enter-url input:hover{background:#000;border-color:#4300ed;}
#enter-url button{
  padding: .7rem 1.6rem;
  margin: .5rem 0;
  font-size: 1.1rem;
  background: #333;
  border: 1px solid;
  border-radius: 1rem;
  color: #fff;
}
#enter-url button:hover{background:#555;border-color:#4300ed;cursor:pointer;}
.url-row {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin: .5rem 0;
}
.buttons {
  display: flex;
  justify-content: center;
  gap: 1rem;
  margin: 1rem 0;
}
.opacity-label, .blend-label {
  display: flex;
  align-items: center;
  font-size: 0.9rem;
  white-space: nowrap;
}
.opacity-slider {width: 100px; margin-left: 0.5rem;}
.opacity-num {
  width: 50px;
  margin-left: 0.5rem;
  padding: 0.3rem;
  background: #222;
  border: 1px solid #555;
  border-radius: 0.3rem;
  color: #fff;
  text-align: center;
}
.opacity-num:hover {background: #000; border-color: #4300ed;}
select {
  margin-left: 0.5rem;
  padding: 0.3rem;
  background: #222;
  border: 1px solid #555;
  border-radius: 0.3rem;
  color: #fff;
}
select:hover {background: #000; border-color: #4300ed;}
a{color:#888;font-size:.8rem;}
a:hover{color:#aaa}
</style>
</head>
<body>
<div id="container">
  <iframe id="bottom-iframe" allowfullscreen allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; fullscreen"></iframe>
</div>
<div id="enter-url">
  No URL provided. Enter a YouTube or other embeddable URL below:<br><br>
  <div id="url-rows"></div>
  <div class="buttons">
    <button id="add-url">Add Another Url</button>
    <button onclick="newEmbedUrl()">Load</button>
  </div><br>
  <a href="https://github.com/Embed-Proxy/embed-proxy.github.io" target="_blank">Embed Proxy on GitHub</a>
</div>
<script>
const pageParams = new URLSearchParams(window.location.search);
let rowCount = 0;
let hasOverlay = false;

function addRow(url = '', op = 1, blend = 'plus-darker', isOverlay = false) {
  rowCount++;
  const row = document.createElement('div');
  row.className = 'url-row';
  row.dataset.index = rowCount;

  const input = document.createElement('input');
  input.type = 'text';
  input.placeholder = isOverlay ? 'https://youtu.be/... (optional overlay)' : 'https://youtu.be/...';
  input.value = url;
  if (rowCount === 1) input.autofocus = true;
  input.addEventListener('keydown', e => { if (e.key === 'Enter') newEmbedUrl(); });
  row.appendChild(input);

  // Only show opacity controls if it's an overlay OR if we already have an overlay (meaning base opacity is now adjustable)
  if (isOverlay || hasOverlay) {
    const opLabel = document.createElement('label');
    opLabel.className = 'opacity-label';
    opLabel.innerHTML = 'Opacity: ';
    const slider = document.createElement('input');
    slider.type = 'range';
    slider.className = 'opacity-slider';
    slider.min = 0; slider.max = 1; slider.step = 0.01; slider.value = op;
    opLabel.appendChild(slider);
    const num = document.createElement('input');
    num.type = 'number';
    num.className = 'opacity-num';
    num.min = 0; num.max = 1; num.step = 0.01; num.value = op;
    opLabel.appendChild(num);
    row.appendChild(opLabel);

    slider.oninput = () => num.value = slider.value;
    num.oninput = () => slider.value = num.value;
  }

  if (isOverlay) {
    hasOverlay = true;
    // Now that an overlay exists, show opacity on the first row if it wasn't already
    const firstRow = document.querySelector('.url-row[data-index="1"]');
    if (firstRow && !firstRow.querySelector('.opacity-label')) {
      const opLabel = document.createElement('label');
      opLabel.className = 'opacity-label';
      opLabel.innerHTML = 'Opacity: ';
      const slider = document.createElement('input');
      slider.type = 'range';
      slider.className = 'opacity-slider';
      slider.min = 0; slider.max = 1; slider.step = 0.01; slider.value = 1;
      opLabel.appendChild(slider);
      const num = document.createElement('input');
      num.type = 'number';
      num.className = 'opacity-num';
      num.min = 0; num.max = 1; num.step = 0.01; num.value = 1;
      opLabel.appendChild(num);
      firstRow.appendChild(opLabel);
      slider.oninput = () => num.value = slider.value;
      num.oninput = () => slider.value = num.value;
    }

    const blendLabel = document.createElement('label');
    blendLabel.className = 'blend-label';
    blendLabel.innerHTML = 'Blend Mode: ';
    const select = document.createElement('select');
    const opts = ['normal','multiply','screen','overlay','darken','lighten','color-dodge','color-burn','hard-light','soft-light','difference','exclusion','hue','saturation','color','luminosity','plus-darker','plus-lighter'];
    opts.forEach(opt => {
      const option = document.createElement('option');
      option.value = opt;
      option.text = opt.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
      if (opt === blend) option.selected = true;
      select.appendChild(option);
    });
    blendLabel.appendChild(select);
    row.appendChild(blendLabel);
  }

  document.getElementById('url-rows').appendChild(row);
}

function newEmbedUrl() {
  const rows = document.querySelectorAll('#url-rows .url-row');
  let search = '';
  let j = 1;
  rows.forEach(row => {
    const urlInput = row.querySelector('input[type="text"]');
    const val = urlInput.value.trim();
    if (val) {
      search += (j === 1 ? '?' : '&') + 'url' + j + '=' + encodeURIComponent(val);
      const opSlider = row.querySelector('.opacity-slider');
      if (opSlider) search += '&op' + j + '=' + opSlider.value;
      const blendSelect = row.querySelector('select');
      if (blendSelect) search += '&blend' + j + '=' + blendSelect.value;
      j++;
    }
  });
  if (search) location.search = search;
}

if (!pageParams.get('url1')) {
  document.getElementById('enter-url').style.display = 'block';
  addRow('', 1, '', false); // first row, no opacity yet
  document.getElementById('add-url').onclick = () => addRow('', 0.65, 'plus-darker', true);
} else {
  document.getElementById('enter-url').style.display = 'none';
  document.body.classList.add('loaded'); // hide overflow

  let i = 1;
  while (true) {
    const url = pageParams.get('url' + i);
    if (!url) break;
    const op = pageParams.get('op' + i) || (i === 1 ? '1' : '0.65');
    const blend = i > 1 ? (pageParams.get('blend' + i) || 'plus-darker') : '';

    let iframe;
    if (i === 1) {
      iframe = document.getElementById('bottom-iframe');
    } else {
      iframe = document.getElementById('bottom-iframe').cloneNode();
      iframe.id = 'iframe-' + i;
      iframe.classList.add('top');
      document.getElementById('container').appendChild(iframe);
    }
    iframe.src = getEmbedSrc(url);
    iframe.style.opacity = op;
    iframe.style.zIndex = i;
    if (i > 1) iframe.style.mixBlendMode = blend;

    // topmost iframe gets pointer events
    iframe.style.pointerEvents = 'none';
    i++;
  }
  // enable pointer events on the very top layer
  const topIframe = document.querySelector('iframe.top') || document.getElementById('bottom-iframe');
  if (topIframe) topIframe.style.pointerEvents = 'auto';
}

// embed parsing logic unchanged
function isPlaylistID(id) { return (id || '').split('?')[0].length > 11; }
function getEmbedSrc(input) {
  if (!input) return '';
  let cleaned = input.replace(/^(https?:\/\/)?(www\.)?/gi, '').replace(/#.*$/, '');
  const parsed = new URL(input.startsWith('http') ? input : 'https://' + input);
  const urlParams = parsed.searchParams;
  let videoId = null;
  let finalParams = new URLSearchParams();
  finalParams.set('autoplay', '1');
  if (cleaned.startsWith('youtube.com/embed/') || cleaned.startsWith('youtube-nocookie.com/embed/')) {
    let url = new URL('https://www.' + cleaned.replace('youtube.com/', 'youtube-nocookie.com/'));
    url.searchParams.set('autoplay', '1');
    return url.toString();
  }
  if (cleaned.startsWith('youtu.be/')) {
    videoId = cleaned.split('youtu.be/')[1].split(/[?&]/)[0];
    if (urlParams.has('t')) {
      const t = parseInt(urlParams.get('t'), 10);
      if (!isNaN(t)) finalParams.set('start', t);
    }
    if (urlParams.has('list')) finalParams.set('list', urlParams.get('list'));
    for (const [k, v] of urlParams) if (!['t', 'list', 'v'].includes(k)) finalParams.set(k, v);
  } else if (cleaned.startsWith('youtube.com/watch')) {
    const v = urlParams.get('v') || cleaned.split('v=')[1]?.split(/[&]/)[0];
    if (v) {
      const ids = v.split(',').filter(Boolean);
      if (ids.length > 1) return `https://www.youtube-nocookie.com/embed/?playlist=${ids.join(',')}&${finalParams.toString()}`;
      videoId = ids[0];
    }
    if (urlParams.has('list')) finalParams.set('list', urlParams.get('list'));
    if (urlParams.has('t')) {
      const t = parseInt(urlParams.get('t'), 10);
      if (!isNaN(t)) finalParams.set('start', t);
    }
    for (const [k, v] of urlParams) if (!['v', 't', 'list'].includes(k)) finalParams.set(k, v);
  } else if (cleaned.startsWith('youtube.com/shorts/')) {
    videoId = cleaned.split('shorts/')[1].split(/[?]/)[0];
    for (const [k, v] of urlParams) finalParams.set(k, v);
  } else if (urlParams.has('list') && !videoId) {
    const list = urlParams.get('list');
    if (isPlaylistID(list)) return `https://www.youtube-nocookie.com/embed/videoseries?list=${list}&${finalParams.toString()}`;
  }
  if (videoId || urlParams.has('list')) {
    if (!videoId && urlParams.has('list')) {
      return `https://www.youtube-nocookie.com/embed/videoseries?list=${urlParams.get('list')}&${finalParams.toString()}`;
    } else {
      return `https://www.youtube-nocookie.com/embed/${videoId}?${finalParams.toString()}`;
    }
  }
  return input;
}
</script>
</body>
</html>
